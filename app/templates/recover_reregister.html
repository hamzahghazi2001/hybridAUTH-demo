{% extends "base.html" %}

{% block title %}Register New Passkey {% endblock %}

{% block content %}
<div class="auth-container">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title text-center mb-3">Account Recovered</h4>
            <p class="text-muted text-center small mb-4">For security, please register a new passkey</p>
            
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" value="{{ email }}" readonly>
            </div>
            
            <button class="btn btn-primary w-100" id="btnRegister">Register New Passkey</button>
            
            <div id="msg" class="mt-3 small" style="white-space: pre-wrap;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const email = "{{ email }}";
const msgEl = document.getElementById("msg");

document.getElementById("btnRegister").addEventListener("click", async () => {
    const btn = document.getElementById("btnRegister");
    
    try {
        btn.disabled = true;
        msgEl.textContent = "Starting passkey registration...";
        msgEl.className = "mt-3 small text-muted";
        
        const startRes = await fetch("/register/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, reregister: true }),
        });

        const startText = await startRes.text();
        if (!startRes.ok) {
            throw new Error(`Registration failed: ${startText.slice(0, 200)}`);
        }

        const startData = JSON.parse(startText);
        const options = startData.publicKey ?? startData;

        msgEl.textContent = "Approve the passkey prompt on your device...";

        const regResp = await SimpleWebAuthnBrowser.startRegistration(options);

        msgEl.textContent = "Verifying passkey...";

        const finishRes = await fetch("/register/finish", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, credential: regResp, reregister: true }),
        });

        const finishText = await finishRes.text();
        if (!finishRes.ok) {
            throw new Error(`Verification failed: ${finishText.slice(0, 200)}`);
        }

        const finishData = JSON.parse(finishText);

        if (finishData.ok) {
            msgEl.textContent = "Success! Redirecting...";
            msgEl.className = "mt-3 small text-success";
            setTimeout(() => (window.location.href = "/dashboard"), 800);
        } else {
            throw new Error(JSON.stringify(finishData));
        }
    } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = "mt-3 small text-danger";
        btn.disabled = false;
    }
});
</script>
{% endblock %}
