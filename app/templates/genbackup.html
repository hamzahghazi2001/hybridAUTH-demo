{% extends "base.html" %}

{% block title %}Backup Codes{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">Generate Backup Codes</div>
            <div class="card-body">
                <p class="text-muted">Backup codes are single-use recovery codes. Store them securely. Generating a new set invalidates any previous codes.</p>
                
                <button class="btn btn-primary" id="btnGenerate">Generate New Backup Codes</button>
                
                <div id="msg" class="mt-4" style="white-space: pre-wrap;"></div>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="{{ url_for('settings') }}">&larr; Back to Settings</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const btn = document.getElementById('btnGenerate');
const msgEl = document.getElementById('msg');

btn.addEventListener('click', async () => {
    btn.disabled = true;
    btn.textContent = 'Generating...';
    msgEl.textContent = '';

    try {
        const response = await fetch('/backup-codes/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok && data.ok) {
            let html = '<div class="alert alert-success">';
            html += '<strong>Save these codes securely. They will not be shown again.</strong>';
            html += '</div>';
            html += '<div class="card bg-light"><div class="card-body"><code>';
            for (const c of (data.codes || [])) {
                html += c + '<br>';
            }
            html += '</code></div></div>';
            html += '<p class="mt-3 text-muted small">Each code can only be used once.</p>';
            
            msgEl.innerHTML = html;
            btn.textContent = 'Codes Generated';
        } else {
            msgEl.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Unknown error') + '</div>';
            btn.disabled = false;
            btn.textContent = 'Generate New Backup Codes';
        }
    } catch (err) {
        msgEl.innerHTML = '<div class="alert alert-danger">Network error: ' + err.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Generate New Backup Codes';
    }
});
</script>
{% endblock %}
