<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate Backup Codes</title>
  </head>

  <body>
    <h1>Generate Backup Codes</h1>

    <p>
      Backup codes are single-use recovery codes. Generate a new set and store them securely.
      Generating a new set should invalidate the old set.
    </p>

    <button id="btnGenerate">Generate new backup codes</button>

    <pre id="msg" style="white-space: pre-wrap; margin-top: 16px;"></pre>

    <p>
      <a href="{{ url_for('settings') }}">Back to settings</a> |
      <a href="{{ url_for('index') }}">Back to home</a>
    </p>

    <script>
      const btn = document.getElementById('btnGenerate');
      const msgEl = document.getElementById('msg');

      btn.addEventListener('click', async () => {
        msgEl.textContent = 'Generating...';

        try {
          const response = await fetch('/backup-codes/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}) 
          });

          const raw = await response.text();
          let data = null;
          try {
            data = JSON.parse(raw);
          } catch {
            msgEl.textContent = `Server returned non-JSON:\n${raw}`;
            return;
          }

          if (response.ok && data.ok) {
            // Show codes ONCE
            let out = '';
            out += (data.message || 'Save these codes securely. They will not be shown again.') + '\n\n';
            out += 'BACKUP CODES:\n';
            for (const c of (data.codes || [])) out += `- ${c}\n`;

            out += '\nIMPORTANT:\n';
            out += '- Store these offline (password manager / notes locked).\n';
            out += '- Anyone with a code can recover the account.\n';
            out += '- Each code should work once.\n';

            msgEl.textContent = out;

            
            btn.disabled = true;
            btn.textContent = 'Codes generated (refresh to generate again)';
          } else {
            msgEl.textContent = 'Error: ' + (data.error || 'Unknown error');
          }
        } catch (err) {
          msgEl.textContent = 'Network error: ' + err.message;
        }
      });
    </script>
  </body>
</html>