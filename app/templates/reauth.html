{% extends "base.html" %}

{% block title %}Re-authenticate{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="card">
        <div class="card-body text-center">
            <h4 class="card-title mb-3">Re-authentication Required</h4>
            <p class="text-muted small mb-4">This action requires recent authentication. Please verify your identity with your passkey.</p>
            
            <button class="btn btn-primary w-100" id="btnReauth">Verify with Passkey</button>
            
            <div id="msg" class="mt-3 small"></div>
            
            <hr class="my-4">
            
            <a href="{{ url_for('logout') }}" class="text-muted small">Logout instead</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const userEmail = "{{ current_user.email }}";

document.getElementById('btnReauth').addEventListener('click', async () => {
    const msgEl = document.getElementById('msg');
    const btn = document.getElementById('btnReauth');
    
    try {
        btn.disabled = true;
        btn.textContent = 'Verifying...';
        msgEl.textContent = '';
        
        const startRes = await fetch('/login/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail }),
        });
        
        const startData = await startRes.json();
        if (!startRes.ok) throw new Error(startData.error || 'Failed to start authentication');
        
        const authResp = await SimpleWebAuthnBrowser.startAuthentication({ optionsJSON: startData });

        const finishRes = await fetch('/login/finish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: userEmail, 
                credential: authResp,
                is_reauth: true 
            }),
        });
        
        const finishData = await finishRes.json();
        
        if (finishData.ok) {
            window.location.href = finishData.redirect || '/dashboard';
        } else {
            msgEl.textContent = finishData.error || 'Verification failed';
            msgEl.className = 'mt-3 small text-danger';
            btn.disabled = false;
            btn.textContent = 'Verify with Passkey';
        }
    } catch (err) {
        msgEl.textContent = err.message;
        msgEl.className = 'mt-3 small text-danger';
        btn.disabled = false;
        btn.textContent = 'Verify with Passkey';
    }
});
</script>
{% endblock %}
