<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-authenticate</title>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
</head>
<body>
    <h1>Please Re-authenticate</h1>
    <p>Your session has expired. Please verify your identity with your passkey.</p>
    
    <button id="btnReauth">Verify with Passkey</button>
    <pre id="msg"></pre>

    <p><a href="{{ url_for('logout') }}">Logout</a></p>

<script>
  const userEmail = "{{ current_user.email }}"; 
  
  document.getElementById('btnReauth').addEventListener('click', async () => {
    try {
      // Get authentication challenge
      const startRes = await fetch('/login/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail }),
      });
      
      const startData = await startRes.json();
      if (!startRes.ok) throw new Error('START failed: ' + startData.error);
      
      // SAuthenticate with passkey
      const authResp = await SimpleWebAuthnBrowser.startAuthentication(startData);
      
      // Verify authentication
      const finishRes = await fetch('/login/finish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          email: userEmail, 
          credential: authResp,
          is_reauth: true 
        }),
      });
      
      const finishData = await finishRes.json();
      
      if (finishData.ok) {
        // redirect back to where user came from
        const nextUrl = "{{ session.get('next_url', '/dashboard') }}";
        window.location.href = nextUrl;
      } else {
        document.getElementById('msg').textContent = 'Error: ' + finishData.error;
        document.getElementById('msg').style.color = 'red';
      }
    } catch (err) {
      document.getElementById('msg').textContent = 'Error: ' + err.message;
      document.getElementById('msg').style.color = 'red';
    }
  });
</script>

</body>
</html>