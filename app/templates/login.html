{% extends "base.html" %}

{% block title %}Login {% endblock %}

{% block content %}
<div class="auth-container">
    <div class="card">
        <div class="card-body">
            <h4 class="card-title text-center mb-4">Login with Passkey</h4>
            
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" placeholder="you@example.com">
            </div>
            
            <button class="btn btn-primary w-100" id="btnLogin">Login</button>
            
            <pre id="msg" class="mt-3 text-danger small" style="white-space: pre-wrap;"></pre>
            
            <hr class="my-4">
            
            <p class="text-muted small text-center mb-2">Lost your device?</p>
            <div class="d-grid gap-2">
                <a href="{{ url_for('recover_request') }}" class="btn btn-outline-secondary btn-sm">Get login link via email</a>
                <a href="{{ url_for('login_backup') }}" class="btn btn-outline-secondary btn-sm">Login with backup code</a>
            </div>
        </div>
    </div>
    
    <p class="text-center mt-3">
        Don't have an account? <a href="{{ url_for('register') }}">Register</a>
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById("btnLogin").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const msgEl = document.getElementById("msg");
    
    if (!email) {
        msgEl.textContent = "Please enter your email";
        return;
    }

    try {
        msgEl.textContent = "";
        
        const startRes = await fetch("/login/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
        });

        const startData = await startRes.json();
        if (!startRes.ok) throw new Error(startData.error || "Login failed");

        const authResp = await SimpleWebAuthnBrowser.startAuthentication(startData);
        
        const finishRes = await fetch("/login/finish", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, credential: authResp })
        });

        const finishData = await finishRes.json();
    
        if (finishData.ok) {
            window.location.href = finishData.redirect;
        } else {
            msgEl.textContent = finishData.error || "Login failed";
        }
        
    } catch (err) {
        msgEl.textContent = err.message;
    }
});

// Allow Enter key to submit
document.getElementById("email").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("btnLogin").click();
});
</script>
{% endblock %}
